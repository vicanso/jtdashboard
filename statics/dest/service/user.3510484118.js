!function(){"use strict";var t=angular.module("jt.service.user",[]);t.factory("user",["$rootScope","$http","$q","utils","debug",function(t,n,r,e,o){function u(t){var r=n.post(l.url,t);return r.then(function(n){s=null,i(n,t.type)}),r}function i(n,r){c=n.data,c.deviation=e.now()-c.now,o("user:%j",c),angular.forEach(a,function(t){t.resolve(angular.copy(c))}),a.length=0,r&&t.$broadcast("user",r)}o=o("user");var s,c,a=[],l={url:"/user?cache=false",session:function(){var t=r.defer();return c?t.resolve(c):s?a.push(t):(this._getSession(),a.push(t)),t.promise},_getSession:function(){s=n.get(l.url),s.then(function(t){i(t)},function(t){angular.forEach(a,function(n){n.reject(t)}),a.length=0})},register:function(t,n){var r={type:"register",account:t,password:CryptoJS.SHA1(n).toString()};return u(r)},login:function(t,n){var r=CryptoJS.SHA1(n).toString();n=CryptoJS.SHA1(r+c.code).toString();var e={type:"login",account:t,password:n};return u(e)},logout:function(){var t=n["delete"](l.url);return t.then(function(t){s=null,i(t,"logout")}),t}};return l}])}(this);