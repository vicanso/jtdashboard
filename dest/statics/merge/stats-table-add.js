/*dest/statics/services/stats.js*/
(function(){var a;a=angular.module("jt.service.stats",["jt.service.debug"]),a.factory("jtStats",["$http","$q","jtDebug",function(a,b,c){var d,e;return d=c("jt.stats"),e={getData:function(c,e){var f,g,h,i;return f={date:c.date,fill:c.fill,point:c.point},h=[],angular.forEach(c.stats,function(d){var e,g,i,j;e=b.defer(),d=angular.extend({},f,d),i="/stats?conditions="+JSON.stringify(d),g={cache:!0},(null!=(j=c.point)?j.interval:void 0)<0&&(i+="&cache=false",g.cache=!1),c.refreshInterval&&(g.cache=!1),a.get(i,g).success(function(a){angular.isArray(a)?angular.forEach(a,function(a){a.chart=d.chart}):a.chart=d.chart,e.resolve(a)}).error(function(a){e.reject(a)}),h.push(e.promise)}),i=function(a){var b;d("getData options:%j, res:%j",c,a),b=[],angular.forEach(a,function(a){angular.isArray(a)?b=b.concat(a):b.push(a)}),e(null,b)},g=function(a){d("getData options%j, err:%j",c,a),e(a)},b.all(h).then(i,g)},getKeys:function(b,c){return a.get("/collection/"+b+"/keys").success(function(a){return d("getKeys res:%j",a),c(null,a)}).error(function(a){return d("getKeys err:%j",a),c(a)})}}}])}).call(this);
/*dest/statics/directives/table.js*/
(function(){var a;a=angular.module("jt.directive.table",["jt.service.debug","jt.service.stats"]),a.directive("jtTable",["$compile","$http","jtDebug","jtStats",function(a,b,c,d){var e,f;return e=c("jt.table"),f=function(a,b){var c,d,e,f,g,h,i;return i=a.getFullYear(),f=a.getMonth()+1,10>f&&(f="0"+f),c=a.getDate()+1,10>c&&(c="0"+c),h=""+i+"-"+f+"-"+c,86400>b&&(d=a.getHours(),10>d&&(d="0"+d),e=a.getMinutes(),10>e&&(e="0"+e),h+=" "+d+":"+e),60>b&&(g=a.getSeconds(),10>g&&(g="0"+g),h+=":"+g),h},{restrict:"A",template:'<div class="jtTable"></div>',link:function(b,c,e){var g,h,i,j,k,l,m;return h=e.jtTable,g=b[h],m=b.$new(),l={index:0,order:0},m.sort=l,m.sortByIndex=function(a){l.index===a?l.order=++l.order%2:(l.index=a,l.order=0)},k=function(a,b){var c,d;c=a.index,d=a.order,b.sort(function(a,b){return a[c]>b[c]?d?1:-1:a[c]<b[c]?d?-1:1:0})},j=function(b){var d,e;e='<div class="panel panel-default"><div class="panel-heading" ng-bind="name"></div><table class="table"><thead><tr><th ng-repeat="th in theadData" ng-click="sortByIndex($index)"><span ng-bind="th"></span><i class="fa" ng-class="{\'fa-sort\' : sort.index != $index, \'fa-sort-desc\' : sort.index == $index && sort.order == 0, \'fa-sort-asc\' : sort.index == $index && sort.order == 1}"></i></th></tr></thead><tbody><tr ng-repeat="data in tableData"><td ng-repeat="td in data track by $index" ng-bind="td"></td></tr></tbody></table></div>',d=c.children("div").html(e),a(d)(b)},i=function(a){return m.name=a.name||"未定义",d.getData(a,function(b,c){var d,e,g,h,i,n,o;return b?void console.dir(error):(e=(null!=(o=a.point)?o.interval:void 0)||60,h={},d=[],g=[],angular.forEach(c,function(a){var b;return b=a.key,g.push(b),angular.forEach(a.values,function(a){var c,g;g=Math.floor(a.t/e)*e*1e3,c=f(new Date(g),e),h[c]||(d.push(c),h[c]={}),h[c][b]=a.v})}),d.sort(),n=["日期"].concat(g),i=[],angular.forEach(d,function(a){var b;b=[a],angular.forEach(g,function(c,d){b[d+1]=h[a][c]}),i.push(b)}),l&&k(l,i),m.theadData=n,m.tableData=i,void j(m))})},b.$watch(h,function(a){a&&i(a)}),m.$watchCollection("sort",function(a){a&&m.tableData&&k(a,m.tableData)})}}}])}).call(this);
/*dest/statics/javascripts/add.js*/
(function(){var a,b;b=angular.module("jt.addPage",[]),b.factory("jtStatsConfig",["$http","jtDebug",function(a,b){var c,d,e,f;return d=b("jt.jtStatsConfig"),e={"最近":-1,"1分钟":60,"5分钟":300,"10分钟":600,"30分钟":1800,"1小时":3600,"2小时":7200,"6小时":21600,"12小时":43200,"1天":86400},c={"当天":[0,0],"7天":[-6,0],"15天":[-14,0],"30天":[-29,0],"当月":["currentMonth",0]},f={getKeys:function(b,c){return a.get("/collection/"+b+"/keys").success(function(a){return d("getKeys res:%j",a),c(null,a)}).error(function(a){return d("getKeys err:%j",a),c(a)})},getIntervalList:function(){return"最近 1分钟 5分钟 10分钟 30分钟 1小时 2小时 6小时 12小时 1天".split(" ")},convertInterval:function(a){return e[a]},getIntervalName:function(a){var b;return b="",angular.forEach(e,function(c,d){a===c&&(b=d)}),b},getDateList:function(){return"当天 7天 15天 30天 当月".split(" ")},getDateRange:function(a){return c[a]},getChartTypes:function(){return JT_GLOBAL.chartTypes}}}]),a=function(a,b,c,d,e,f,g,h,i){var j,k,l;j=e("jt.addPage"),a.intervalList=i.getIntervalList(),a.chartTypes=i.getChartTypes(),a.config={stats:[{chart:"line"}],chartType:a.chartTypes[0].type},d(function(){var b,c;JT_GLOBAL.config&&(c=[],b=[],angular.forEach(JT_GLOBAL.config.stats,function(a){var d;d={},angular.forEach(a.keys,function(a){d[a.value]=!0}),c.push({category:a.category,chart:a.chart}),b.push(d)}),a.config={name:JT_GLOBAL.config.name,desc:JT_GLOBAL.config.desc,stats:c,interval:i.getIntervalName(JT_GLOBAL.config.point.interval),startDate:JT_GLOBAL.config.date.start,endDate:JT_GLOBAL.config.date.end,chartType:JT_GLOBAL.config.type,refreshInterval:JT_GLOBAL.config.refreshInterval},d(function(){return angular.forEach(a.config.stats,function(a,c){a.keys=b[c]})},100))},100),a.error={},a.success={},a.dateList=i.getDateList(),a.categoryList=JT_GLOBAL.collections,a.keys={},k=g.memoize(i.getKeys),l=function(){var b,c,d,e;return b=a.config,c=[],b.interval||c.push("请选择时间间隔"),b.startDate||0===b.startDate||c.push("请选择开始日期"),b.endDate||0===b.endDate||c.push("请选择结束日期"),c.length?void(a.error.save=c.join(",")):(e=b.refreshInterval,d={name:b.name,desc:b.desc,type:b.chartType,point:{interval:i.convertInterval(b.interval)},date:{start:b.startDate,end:b.endDate},refreshInterval:e,stats:[]},angular.forEach(b.stats,function(a){var b;return b={chart:a.chart,category:a.category,keys:[]},angular.forEach(a.keys,function(a,c){return a?b.keys.push({value:c}):void 0}),d.stats.push(b)}),j("options:%j",d),d)},a.selectChartType=function(b){a.config.chartType=b},a.addParamSelector=function(){a.config.stats.push({chart:a.config.chartType})},a.deleteParamSelector=function(b){a.config.stats.splice(b,1)},a.preview=function(){var b;a.error.save="",b=l(),console.dir(b),"table"===b.type?(a.chartOptions=null,a.tableOptions=b):(a.tableOptions=null,a.chartOptions=b)},a.save=function(){var c,e,f,g,h;return a.error.save="",f=l(),c=[],f.name||c.push("统计名称不能为空"),f.desc||c.push("统计描述不能为空"),c.length?void(a.error.save=c.join(",")):(g=function(){a.success.save="已成功保存配置，3秒后刷新页面",d(function(){return window.location.reload()},3e3)},e=function(b){a.error.save="保存配置失败，"+b.msg},h="/config",JT_GLOBAL.config&&(h+="/"+JT_GLOBAL.config._id),void b.post(h,f).success(g).error(e))},a.$watch("config.stats",function(b,c){return angular.forEach(b,function(b,d){var e,f;f=c[d],e=b.category,e&&e!==(null!=f?f.category:void 0)&&(a.keys[e]||k(e,function(b,c){c&&(a.keys[e]=c)}))})},!0),a.$watch("config.chartType",function(b){var c,d;d={line:"line stack".split(" "),bar:"barVertical barHorizontal stackBarVertical stackBarHorizontal".split(" "),pie:"pie nestedPie"},c="none",angular.forEach(d,function(a,d){~a.indexOf(b)&&(c=d)}),angular.forEach(a.config.stats,function(a){a.chart=c}),a.chartTypeStatusDict="pie"===c?{line:!1,bar:!1,pie:!0}:"line"===c||"bar"===c?{line:!0,bar:!0,pie:!1}:{line:!1,bar:!1,pie:!1}}),a.$watch("config.date",function(b){var c;c=i.getDateRange(b),c&&(a.config.startDate=c[0],a.config.endDate=c[1])}),c.removeClass("hidden")},a.$inject=["$scope","$http","$element","$timeout","jtDebug","$log","jtUtils","user","jtStatsConfig"],angular.module("jtApp").addRequires(["jt.addPage"]).controller("AddPageController",a)}).call(this);