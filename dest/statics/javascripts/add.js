(function(){var a,b;b=angular.module("jt.addPage",[]),b.factory("jtStatsConfig",["$http","jtDebug",function(a,b){var c,d,e,f;return d=b("jt.jtStatsConfig"),e={"最近":-1,"1分钟":60,"5分钟":300,"10分钟":600,"30分钟":1800,"1小时":3600,"2小时":7200,"6小时":21600,"12小时":43200,"1天":86400},c={"当天":[0,0],"7天":[-6,0],"15天":[-14,0],"30天":[-29,0],"当月":["currentMonth",0]},f={getKeys:function(b,c){return a.get("/collection/"+b+"/keys").success(function(a){return d("getKeys res:%j",a),c(null,a)}).error(function(a){return d("getKeys err:%j",a),c(a)})},getIntervalList:function(){return"最近 1分钟 5分钟 10分钟 30分钟 1小时 2小时 6小时 12小时 1天".split(" ")},convertInterval:function(a){return e[a]},getIntervalName:function(a){var b;return b="",angular.forEach(e,function(c,d){a===c&&(b=d)}),b},getDateList:function(){return"当天 7天 15天 30天 当月".split(" ")},getDateRange:function(a){return c[a]},getChartTypes:function(){return JT_GLOBAL.chartTypes}}}]),a=function(a,b,c,d,e,f,g,h,i){var j,k,l;j=e("jt.addPage"),a.intervalList=i.getIntervalList(),a.chartTypes=i.getChartTypes(),a.config={stats:[{chart:"line"}],chartType:a.chartTypes[0].type},d(function(){var b,c;JT_GLOBAL.config&&(c=[],b=[],angular.forEach(JT_GLOBAL.config.stats,function(a){var d;d={},angular.forEach(a.keys,function(a){d[a.value]=!0}),c.push({category:a.category,chart:a.chart}),b.push(d)}),a.config={name:JT_GLOBAL.config.name,desc:JT_GLOBAL.config.desc,stats:c,interval:i.getIntervalName(JT_GLOBAL.config.point.interval),startDate:JT_GLOBAL.config.date.start,endDate:JT_GLOBAL.config.date.end,chartType:JT_GLOBAL.config.type,refreshInterval:JT_GLOBAL.config.refreshInterval},d(function(){return angular.forEach(a.config.stats,function(a,c){a.keys=b[c]})},100))},100),a.error={},a.success={},a.dateList=i.getDateList(),a.categoryList=JT_GLOBAL.collections,a.keys={},k=g.memoize(i.getKeys),l=function(){var b,c,d,e;return b=a.config,c=[],b.interval||c.push("请选择时间间隔"),b.startDate||0===b.startDate||c.push("请选择开始日期"),b.endDate||0===b.endDate||c.push("请选择结束日期"),c.length?void(a.error.save=c.join(",")):(e=b.refreshInterval,d={name:b.name,desc:b.desc,type:b.chartType,point:{interval:i.convertInterval(b.interval)},date:{start:b.startDate,end:b.endDate},refreshInterval:e,stats:[]},angular.forEach(b.stats,function(a){var b;return b={chart:a.chart,category:a.category,keys:[]},angular.forEach(a.keys,function(a,c){return a?b.keys.push({value:c}):void 0}),a.regKey&&b.keys.push({value:a.regKey,type:"reg"}),d.stats.push(b)}),j("options:%j",d),d)},a.selectChartType=function(b){a.config.chartType=b},a.addParamSelector=function(){a.config.stats.push({chart:a.config.chartType})},a.deleteParamSelector=function(b){a.config.stats.splice(b,1)},a.preview=function(){var b;a.error.save="",b=l(),a.statsOptions=b},a.save=function(){var c,e,f,g,h;return a.error.save="",f=l(),c=[],f.name||c.push("统计名称不能为空"),f.desc||c.push("统计描述不能为空"),c.length?void(a.error.save=c.join(",")):(g=function(){a.success.save="已成功保存配置，3秒后刷新页面",d(function(){return window.location.reload()},3e3)},e=function(b){a.error.save="保存配置失败，"+b.msg},h="/config",JT_GLOBAL.config&&(h+="/"+JT_GLOBAL.config._id),void b.post(h,f).success(g).error(e))},a.$watch("config.stats",function(b,c){return angular.forEach(b,function(b,d){var e,f;f=c[d],e=b.category,e&&e!==(null!=f?f.category:void 0)&&(a.keys[e]||k(e,function(b,c){c&&(a.keys[e]=c)}))})},!0),a.$watch("config.chartType",function(b){var c,d;d={line:"line stack".split(" "),bar:"barVertical barHorizontal stackBarVertical stackBarHorizontal".split(" "),pie:"pie nestedPie"},c="none",angular.forEach(d,function(a,d){~a.indexOf(b)&&(c=d)}),angular.forEach(a.config.stats,function(a){a.chart=c}),a.chartTypeStatusDict="pie"===c?{line:!1,bar:!1,pie:!0}:"line"===c||"bar"===c?{line:!0,bar:!0,pie:!1}:{line:!1,bar:!1,pie:!1}}),a.$watch("config.date",function(b){var c;c=i.getDateRange(b),c&&(a.config.startDate=c[0],a.config.endDate=c[1])}),c.removeClass("hidden")},a.$inject=["$scope","$http","$element","$timeout","jtDebug","$log","jtUtils","user","jtStatsConfig"],angular.module("jtApp").addRequires(["jt.addPage"]).controller("AddPageController",a)}).call(this);